<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#3498db">
    <meta name="description" content="Easy Outlook - 批量令牌邮箱快捷管理工具，支持移动端，提供邮件查看、管理等功能">
    <title>Easy Outlook - 移动端优化版</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="152x152" href="./icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="./icons/icon-192x192.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="./icons/icon-72x72.png">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="./css/styles.css">
    <link rel="stylesheet" href="./css/mobile.css">
</head>
<body>
    <div class="app-container">
        <!-- 头部 -->
        <header class="header">
            <h1>Easy Outlook----批量令牌邮箱快捷管理</h1>
            <div style="display:flex; align-items:center; gap:10px;">
                <div id="statusMessage" class="status-message"></div>
            </div>
        </header>

        <!-- 移动端导航栏 -->
        <nav class="mobile-nav" id="mobileNav">
            <button type="button" class="mobile-nav-btn active" data-target="sidebar" onclick="switchMobileView('sidebar')">设置</button>
            <button type="button" class="mobile-nav-btn" data-target="email-sidebar" onclick="switchMobileView('email-sidebar')">邮件列表</button>
            <button type="button" class="mobile-nav-btn" data-target="main-content" onclick="switchMobileView('main-content')">邮件内容</button>
        </nav>

        <!-- 左侧边栏 -->
        <aside class="sidebar">
            <!-- 设置区域 -->
            <div class="sidebar-section" id="importSection">
                <div class="section-header" onclick="toggleImportSection()">
                    <h2>设置</h2>
                    <div style="display: flex; align-items: center;">
                        <span id="sectionStatus" style="font-size: 0.8rem; margin-right: 5px; color: #666;">收起</span>
                        <button id="toggleImportBtn" class="toggle-btn" onclick="toggleImportSection(); event.stopPropagation()">▶</button>
                    </div>
                </div>
            </div>
            <div id="importContent" class="section-content collapsed">
                <div class="input-group">
                    <div class="input-header">
                        <label for="mailboxInput">手动输入邮箱配置</label>
                        <div class="separator-input">
                            <label for="separatorInput">分隔符:</label>
                            <input type="text" id="separatorInput" value="----" class="small-input">
                        </div>
                    </div>
                    <textarea id="mailboxInput" placeholder="格式: email----password----client_id----refresh_token" class="dropzone"></textarea>
                    <div class="drag-hint">支持拖曳文件上传</div>
                </div>
                <div class="control-group" style="margin-bottom: 15px;">
                    <div class="file-input-wrapper">
                        <input type="file" id="fileInput" class="file-input" accept=".txt">
                        <label for="fileInput" class="file-input-label">选择文件</label>
                    </div>
                    <button onclick="parseMailboxInput()">添加邮箱</button>
                </div>
                <div class="control-group" style="margin-bottom: 15px;">
                    <button onclick="exportMailboxes()" class="secondary" title="导出所有邮箱到TXT文件">导出所有邮箱</button>
                    <button onclick="exportSelectedMailbox()" class="secondary" title="复制选中邮箱的完整信息">复制选中邮箱</button>
                </div>
                <div class="control-group" style="margin-bottom: 15px; gap: 8px; flex-wrap: wrap;">
                    <button id="bulkDeleteToggle" class="warning" style="flex: 1 1 48%;" onclick="toggleBulkDeleteMode()">开启批量删除</button>
                    <button class="secondary" style="flex: 1 1 48%;" onclick="validateAllMailboxes()">检测邮箱有效性</button>
                </div>
                <div class="control-group" id="bulkDeleteActions" style="display: none; gap: 8px; flex-wrap: wrap;">
                    <button class="secondary small-btn" style="flex: 1 1 30%;" onclick="bulkToggleSelectAll()">全选 / 全不选</button>
                    <button class="secondary small-btn" style="flex: 1 1 30%;" onclick="bulkClearSelection()">清空选择</button>
                    <button class="warning small-btn" style="flex: 1 1 30%;" onclick="bulkDeleteMailboxes()">批量删除</button>
                </div>
                <!-- API 配置已移至后端环境变量，无需前端配置 -->
            </div>

            <!-- 购买邮箱区域 -->
            <div class="sidebar-section" id="purchaseSection">
                <div class="section-header" onclick="togglePurchaseSection()">
                    <h2>购买邮箱</h2>
                    <div style="display: flex; align-items: center;">
                        <span id="purchaseSectionStatus" style="font-size: 0.8rem; margin-right: 5px; color: #666;">收起</span>
                        <button id="togglePurchaseBtn" class="toggle-btn" onclick="togglePurchaseSection(); event.stopPropagation()">▶</button>
                    </div>
                </div>
            </div>
            <div id="purchaseContent" class="section-content collapsed">
                <div class="input-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px;">
                        <label>账户余额</label>
                        <button onclick="checkBalance()" class="small-btn">查询余额</button>
                    </div>
                    <div id="balanceDisplay" style="margin-top: 3px; font-size: 0.8rem; color: #3498db; font-weight: bold;">
                        点击"查询余额"获取账户信息
                    </div>
                </div>
                <div class="input-group">
                    <label for="purchaseLibrary">选择仓库</label>
                    <select id="purchaseLibrary" class="form-control" onchange="onPurchaseLibraryChange()">
                        <option value="1">一号库</option>
                        <option value="2">二号库</option>
                    </select>
                </div>
                <div class="input-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px;">
                        <label for="commodityId">商品</label>
                        <button onclick="checkStock()" class="small-btn">查询库存</button>
                    </div>
                    <select id="commodityId" class="form-control"></select>
                    <div id="stockDisplay" style="margin-top: 3px; font-size: 0.8rem; color: #3498db; font-weight: bold;">
                        点击"查询库存"获取当前库存信息
                    </div>
                </div>
                <div class="input-group">
                    <label for="purchaseNum">购买数量 (1-2000)</label>
                    <input type="number" id="purchaseNum" min="1" max="2000" value="1" class="form-control">
                </div>
                <div class="control-group" style="margin-top: 15px;">
                    <button onclick="purchaseEmails()" style="background-color: #27ae60;">购买邮箱</button>
                </div>
            </div>

            <!-- 邮箱列表区域 -->
            <div class="sidebar-section" id="mailboxSection">
                <div class="section-header" onclick="toggleMailboxSection()">
                    <h2>邮箱列表</h2>
                    <div style="display: flex; align-items: center;">
                        <span id="mailboxSectionStatus" style="font-size: 0.8rem; margin-right: 5px; color: #666;">展开</span>
                        <button id="toggleMailboxBtn" class="toggle-btn" onclick="toggleMailboxSection(); event.stopPropagation()">▼</button>
                    </div>
                </div>
            </div>
            <div id="mailboxContent" class="mailbox-list-content">  <!-- 邮箱列表保持展开 -->
                <ul id="mailboxList" class="mailbox-list"></ul>
            </div>
        </aside>

        <!-- 邮件列表区域 -->
        <aside class="email-sidebar">
            <div class="sidebar-section">
                <div class="section-header">
                    <h2>邮件列表</h2>
                    <div class="control-group" style="margin-bottom: 0;">
                        <select id="mailboxFolderList">
                            <option value="INBOX" selected>收件箱</option>
                            <option value="Junk">垃圾邮件</option>
                        </select>
                        <button onclick="loadEmailList()" class="small-btn">刷新</button>
                    </div>
                </div>
            </div>
            <ul id="emailList" class="email-list">
                <div class="empty-state">
                    <p>选择一个邮箱查看邮件</p>
                </div>
            </ul>
        </aside>

        <!-- 主内容区域 -->
        <main class="main-content">
            <!-- 工具栏 -->
            <div class="main-toolbar">
                <div class="section-header">
                    <div class="control-group" style="margin-bottom: 0;">
                        <label for="responseType">格式:</label>
                        <select id="responseType">
                            <option value="json" selected>JSON</option>
                            <option value="html">HTML</option>
                        </select>
                        <button onclick="fetchEmail()">获取最新邮件</button>
                    </div>
                    <div class="control-group" style="margin-bottom: 0;">
                        <button class="secondary" onclick="clearEmailDisplay()">清除显示</button>
                        <button class="warning" onclick="clearInbox()">清空收件箱</button>
                        <button class="warning" onclick="clearJunk()">清空垃圾箱</button>
                    </div>
                </div>
            </div>

            <!-- 标签页 -->
            <div class="tabs">
                <div class="tab active" onclick="switchTab('emailTab')">邮件内容</div>
                <div class="tab" onclick="switchTab('rawTab')">JSON格式</div>
            </div>

            <!-- 邮件内容区域 -->
            <div id="emailTab" class="email-container" style="display: block;">
                <div id="emailHeader" class="email-header" style="display: none;">
                    <div id="emailSubject" class="email-subject"></div>
                    <div class="email-meta">
                        <div id="emailFrom" class="email-from"></div>
                        <div id="emailDate"></div>
                    </div>
                </div>

                <div id="emailViewer" class="email-viewer">
                    <div id="emptyState" class="empty-state">
                        <p>选择一个邮箱并点击"获取邮件"来查看最新邮件</p>
                    </div>
                    <div id="loadingMessage" class="loading" style="display: none;">
                        正在加载邮件内容...
                    </div>
                    <iframe id="emailFrame" style="display: none; flex: 1;"></iframe>
                </div>
            </div>

            <!-- 原始数据区域 -->
            <div id="rawTab" class="email-container" style="display: none;">
                <pre id="rawData" class="raw-data"></pre>
            </div>
        </main>
    </div>

    <!-- 加载JavaScript模块 -->
    <script type="module">
        import { initApp } from './js/app.js';
        import { initMobileEnhancements } from './js/mobile-enhance.js';
        
        // 初始化应用
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('📱 移动端优化版启动中...');
            
            // 初始化主应用
            await initApp();
            
            // 初始化移动端增强功能
            initMobileEnhancements();
            
            // 注册Service Worker (PWA支持)
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js');
                    console.log('✅ Service Worker 注册成功:', registration.scope);
                    
                    // 监听更新
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('🔄 发现新版本');
                        
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // 新版本已就绪，提示用户刷新
                                if (confirm('发现新版本，是否立即更新？')) {
                                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                                    window.location.reload();
                                }
                            }
                        });
                    });
                    
                    // 监听控制器变化
                    navigator.serviceWorker.addEventListener('controllerchange', () => {
                        console.log('🔄 Service Worker 已更新');
                    });
                    
                } catch (error) {
                    console.error('❌ Service Worker 注册失败:', error);
                }
            }
            
            // PWA安装提示
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                console.log('💡 PWA可以安装');
                
                // 显示安装提示（可选）
                showInstallPrompt();
            });
            
            function showInstallPrompt() {
                const installBanner = document.createElement('div');
                installBanner.className = 'install-banner';
                installBanner.innerHTML = `
                    <div class="install-banner-content">
                        <span>📱 安装应用到主屏幕，获得更好的体验</span>
                        <div>
                            <button onclick="this.parentElement.parentElement.parentElement.style.display='none'" class="btn-dismiss">稍后</button>
                            <button onclick="installPWA()" class="btn-install">安装</button>
                        </div>
                    </div>
                `;
                installBanner.style.cssText = `
                    position: fixed;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 15px;
                    box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
                    z-index: 9999;
                    animation: slideUp 0.3s ease;
                `;
                
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes slideUp {
                        from { transform: translateY(100%); }
                        to { transform: translateY(0); }
                    }
                    .install-banner-content {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        gap: 10px;
                        flex-wrap: wrap;
                    }
                    .install-banner-content > div {
                        display: flex;
                        gap: 10px;
                    }
                    .install-banner button {
                        padding: 8px 16px;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: bold;
                        transition: transform 0.2s ease;
                    }
                    .install-banner button:active {
                        transform: scale(0.95);
                    }
                    .btn-dismiss {
                        background: rgba(255,255,255,0.3);
                        color: white;
                    }
                    .btn-install {
                        background: white;
                        color: #667eea;
                    }
                `;
                
                document.head.appendChild(style);
                document.body.appendChild(installBanner);
                
                // 全局安装函数
                window.installPWA = async () => {
                    if (!deferredPrompt) return;
                    
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`用户选择: ${outcome}`);
                    
                    if (outcome === 'accepted') {
                        console.log('✅ PWA已安装');
                    }
                    
                    deferredPrompt = null;
                    installBanner.style.display = 'none';
                };
                
                // 24小时后再次显示
                setTimeout(() => {
                    installBanner.style.display = 'none';
                }, 24 * 60 * 60 * 1000);
            }
            
            // 应用安装成功
            window.addEventListener('appinstalled', () => {
                console.log('🎉 PWA安装成功');
                if (window.setStatusMessage) {
                    window.setStatusMessage('应用已添加到主屏幕', 'success');
                }
            });
            
            console.log('✅ 移动端优化版启动完成');
        });
    </script>
</body>
</html>
